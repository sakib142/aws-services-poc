<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings version="2.0"
	xmlns="http://java.sun.com/xml/ns/persistence/orm"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/persistence/orm http://java.sun.com/xml/ns/persistence/orm_2_0.xsd">

	<named-native-query name="ems.fetchInstrument">
		<query><![CDATA[
			SELECT
			IMS.ID ID,
			IMS.ISIN ISIN,
			IMS.CUSIP CUSIP,
			IMS.CINS CINS,
			IMS.BONDTYPE BONDTYPE,
			IMS.TRACE_CODE TRACECODE,
			IMS.SHORTNAME SHORTNAME,
			IMS.DEFAULTTICKER TICKER,
			IMS.COUPON,
			IMS.PAYMENTFREQUENCY COUPONFREQUENCY,
			IMS.INTERESTRATETYPE COUPONTYPE,
			IMS.MATURITY MATURITYDATE,
			IMS.ISSUEDATE ISSUEDATE,
			IMS.ACCRUALSTART ACCRUALSTARTDATE,
			IMS.NEXTPAYDATE NEXTPAYMENTDATE,
			IMS.ISSUEAMOUNT ISSUEAMOUNT,
			IMS.AMOUNTOUTSTANDING AMOUNTOUTSTANDING,
			UTC.SHORTNAME CURRENCY,
			IMS.COUNTRYCODE COUNTRY,
			IMS.ISSUER ISSUER,
			INC.DESCRIPTION INDUSTRYSECTOR,
			IMS.DEBT_TYPE_CD DEBTCLASSIFICATION,
			DECODE(UTP.TYPE,3,UTP.LONGSTRING,NULL) MOODYRATING,
			DECODE(UTP.TYPE,1,UTP.LONGSTRING,NULL) SANDPRATING,
			IMS.NEXTCALLDATE NEXTCALLDATE,
			IMS.DISPLAY_CALL_PRICE NEXTCALLPRICE,
			IMS.NEXTPUTDATE NEXTPUTDATE,
			IMS.CALC_ISSUE CALCFLAG,
			IMS.DV01_WORST DV01WORST,
			IMS.MOD_DUR_WORST MODIFIEDDURATIONWORST,
			IPR.MARKETSEGMENTID MARKETSEGMENTID,
			MSG.MARKETSEGMENT MARKETSEGMENTCODE,
			IPR.PRODUCT_CD PRODUCTCODE,
			IPI.ISDEFAULT PRODUCTISDEFAULT,
			ITP.SHORTNAME PROTOCOL,
			IMS.ISDELETED ISDELETED,
			IMS.TIMESTAMP UPDATETS
	FROM
		INSTRUMENT_MASTERSECURITY IMS
		INNER JOIN INSTRUMENT_MARKETSEGMENT MSG 
			ON MSG.ID = IMS.MARKETSEGMENT
		INNER JOIN UTIL_CURRENCY UTC
			ON UTC.ISOCODE = IMS.ISOCURRENCYCODE
		INNER JOIN INSTRUMENT_SECTOR INC
			ON IMS.SECTORID = INC.ID
		INNER JOIN UTIL_TEMAP UTP 
			ON ( UTP.ID = IMS.MOODYRATING OR UTP.ID = IMS.SNPRATING )
		INNER JOIN INSTRUMENT_PRODUCTINSTRUMENTS IPI
			ON IPI.INSTRUMENTID = IMS.ID
		INNER JOIN INSTRUMENT_PRODUCT IPR
			ON IPR.ID = IPI.PRODUCTID
			AND IPR.MARKETSEGMENTID = IMS.MARKETSEGMENT
		INNER JOIN INSTRUMENT_PRODUCTPROTOCOLS IPP
			ON IPP.PRODUCTID = IPI.PRODUCTID			
		INNER JOIN INQUIRY_TRADINGPROTOCOL ITP 
			ON ITP.TRADINGPROTOCOLID = IPP.PROTOCOLID
		WHERE IMS.TIMESTAMP > :lastExcTmstp
		and IMS.TIMESTAMP <= :currentTimestamp
		]]></query>
	</named-native-query>
</entity-mappings>